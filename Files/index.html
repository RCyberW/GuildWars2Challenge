<!DOCTYPE html>
<html>
    <head> 
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <title>Demo app</title>
		<link type="text/css" rel="stylesheet" href="css/style.css">
		<script src="js/jquery-1.11.2.min.js"></script>
        <script>
			//DEBUGGING CODE
			var debugmode = true;
			
			if(debugmode) {
				$(window).on('keypress', function(e) {
					if(e.keyCode == 100) {
						$('#debug-menu').slideToggle(300);
						$('#debug-menu').scrollTop($('#debug-menu').prop('scrollHeight'));
					}
				});
			}
			
			function debug(string) {
				$('#debug-menu').append(string + '<br>');
				$('#debug-menu').scrollTop($('#debug-menu').prop('scrollHeight'));
			}
			
			// CONSTANTS
			var MILLISECONDS = 1000;
			
			// GUILD WARS 2 JSON CALLS
			var pricev2JSON = "https://api.guildwars2.com/v2/commerce/prices";
			var itemv2JSON = "https://api.guildwars2.com/v2/items";
			var itemsv1JSON = "https://api.guildwars2.com/v1/items.json";
			
			// GLOBAL VARS
			var count = 0;
		
            function listItemInfo() {
				var itemList;
				$.getJSON( itemv2JSON, function( data ) {
					itemList = data;
					
				});
			}
			
			function getItemPrices() {
				count++;
				var itemIds = [19684, 13328, 2279];
				
				var priceDetail;
				var itemDetail;
				var i;
				var priceIds;
				
				// Create starting query
				if (itemIds.length > 1) {
					priceIds = "?ids=";
					for(i = 0; i < itemIds.length; i++) {
						priceIds += itemIds[i] + ","
					}
				} else {
					priceIds = "/" + itemIds[0];
				}
				
				$("#debugMode").value = count;
				
				$.getJSON( pricev2JSON + priceIds, function( prices ) {
					priceDetail = prices;
					$.getJSON( itemv2JSON  + priceIds, function( items ) {
						itemDetail = items;
						for (i = 0; i < itemDetail.length; i++) {
							var itemId = priceDetail[i].id;
							
							if ($("#" + itemId + "_price").length == 0) {
								// It doesn't exist, write the values
								$('#pricewatch tr:last').after('<tr><td id=' + itemId + '_name>' + itemDetail[i].name + '</td><td id=' + itemId + '_price>' + priceDetail[i].buys.unit_price + '</td></tr>');
							} else {
								// It exists, update values
								$("#" + itemId + "_name").value = itemDetail[i].name;
								$("#" + itemId + "_price").value = priceDetail[i].buys.unit_price;
							}
						}
					});
				});
			}
			
			var myVar;
			function myFunction() {
				getItemPrices();
				myVar = setInterval(getItemPrices, 60 * MILLISECONDS);
			}
			
			// OverWolf Window functions
			function dragResize(edge){
                overwolf.windows.getCurrentWindow(function(result){
                    if (result.status=="success"){
                        overwolf.windows.dragResize(result.window.id, edge);
                    }
                });
            };
            function dragMove(){
                overwolf.windows.getCurrentWindow(function(result){
                    if (result.status=="success"){
                        overwolf.windows.dragMove(result.window.id);
                    }
                });
            };
            function closeWindow(){
                overwolf.windows.getCurrentWindow(function(result){
                    if (result.status=="success"){
                        overwolf.windows.close(result.window.id);
                    }
                });
            };
        </script>
    </head>

    <body>
		<div id="resize-bar" onmousedown="dragResize('BottomRight');">resize</div>
		<div id="top-bar" onmousedown="dragMove();">
			<div id="close-button" onclick="closeWindow()">X</div>
		</div>
		<div id="debug-menu">--Debug Menu--<br><br></div>
		<div id="main-content">
			<table id="pricewatch">
				<tr>
					<th style="text-align: left;">Item</th>
					<th style="text-align: left;">Price</th>
				</tr>
			</table>
			<button onclick="myFunction();">Update</button>
		</div>
    </body>
</html>